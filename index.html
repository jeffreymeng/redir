<!DOCTYPE html>
<html>

<head>

    
<script src="https://www.gstatic.com/firebasejs/3.6.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDoXIdwM34SiFL2jB055Jo4VdyJk-pVIDA",
    authDomain: "jcabinet.firebaseapp.com",
    databaseURL: "https://jcabinet.firebaseio.com",
    storageBucket: "firebase-jcabinet.appspot.com",
    messagingSenderId: "1056566579088"
  };
  firebase.initializeApp(config);
</script>

    <script>
        /* global Firebase */
        var name = window.location.hash.substring(1);
        
        if (name !== null && name !== "" && name !== undefined) {
            firebase.database().ref("/links/jmls/" + name + "/").once("value", function(data) {
                if (data.val() !== null) {
                    var meta = document.createElement('meta');
                    meta.httpEquiv = "refresh";
                    meta.content = "0; URL=" + snapshot.child(name).val();
                    document.getElementsByTagName('head')[0].appendChild(meta);

                }
            });
        }
    </script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <title>JMLS - Jeffrey Meng Link Shortner.</title>
</head>

<body>
    <div class="container">
        <div class="col-lg-12">
            <h1>JMLS(Jeffrey Meng Link Shortner)</h1>
            <p class="text-muted">Jeffrey's link shortning service.</p>
            <div id="create">
                <p>Welcome to JMLS</p>
                <p>Create a redirection link below:</p>
                <div>

                    <label for="basic-url">Choose a short URL</label>
                    <div class="input-group">
                        <span class="input-group-addon" id="basic-addon3">http://jmls.tk/</span>
                        <input aria-describedby="basic-addon3" class="form-control" id="url" placeholder="url" type="text">
                    </div><br>
                    <p id="console-text" class="text text-success" style="display:none;">Hi,<br> Type in a command or create a url normally. type /admin logout to logout or /help for help</p>
                    <p id="console" class="text-muted text"></p>
                    <label for="link">Link to redirect to(include http:// or https:// )</label> <input class="form-control" id="link" placeholder="https://" type="text"><br>
                    <p class="text-danger text" id="error"></p>
                    <p class="text-success text" id="success">
                    </p><button class="form-control" id="sub" style="background-color:green;color:white;" onclick="setup()">Submit</button>
                </div>
            </div>
            <script src="http://code.jquery.com/jquery-1.11.3.min.js">
            </script>
            <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js">
            </script>
            <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js">
            </script>
            <script>
               
                function checkIfURLExists(id, link, callback) {
                    firebase.database().ref("/links/jmls/" + id + "/").once('value', function(snapshot) {
                        var exists = (snapshot.val() !== null);
                        callback(exists, id, link);
                    });
                }
                

                function setup() {
                    
                    var url = $("#url").val();
                    var link = $("#link").val();

                    var linkregex = new RegExp("(https?:|ftp:)\/\/.+", "g");
                    var urlregex = new RegExp("[A-Za-z0-9-_]", "g");
                    if (link.substring(0, 1) === "/") {
                        compute(link);
                    }
                    else {
                        if (!linkregex.test(link)) {
                            $("#success").html("");
                            $("#error").html("The link to redirect to must be valid with http:// or https://");
                        }
                        else if (!urlregex.test(link)) {
                            $("#success").html("");
                            $("#error").html("the short url must only contain dashes(-), underscores(_), and alphanumeric charcters");
                        }
                        else {
                            checkIfURLExists(url, link, function(exists, id, link) {
                                if (exists) {
                                    $("#success").html("");
                                    $("#error").html("Your url already exists!");
                                }
                                else {
                                    $("#link").val("");
                                    $("#url").val("");
                                    fb.child(url).set(link);
                                    $("#success").html("Success! The link <b>http://jmls.tk/" + url + "<\/b> now redirects to <b>" + link + "<\/b>. If you are embedding this link, use <b>http://jmls.tk/#" + url + "<\/b>.");
                                    url.val("");
                                    link.val("");

                                }
                            });
                        }
                    }

                }
            </script>
        </div>
    </div>
</body>

</html>