<!DOCTYPE html>
<html>

<head>



    <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyDoXIdwM34SiFL2jB055Jo4VdyJk-pVIDA",
            authDomain: "jcabinet.firebaseapp.com",
            databaseURL: "https://jcabinet.firebaseio.com",
            projectId: "firebase-jcabinet",
            storageBucket: "firebase-jcabinet.appspot.com",
            messagingSenderId: "1056566579088"
        };
        firebase.initializeApp(config);
    </script>

    <script>
        /* global firebase */
        var name = window.location.hash.substring(1);

        if (name !== null && name !== "" && name !== undefined) {
            firebase.database().ref("/links/jmls/" + name + "/link/").once("value").then(function (data) {
                if (data.val() !== null) {
                    window.location.href = data.val();

                }
            });
        }
    </script>
    <link href="https://cdn.jeffkmeng.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <title>JMLS - Jeffrey Meng Link Shortener</title>
</head>

<body>
    <div class="container">
        <div class="col-lg-12">
            <h1>JMKLS(Jeffrey Meng Link Shortener)</h1>
            <p class="text-muted">Jeffrey's link shortening service.</p>
            <hr>
            <div id="create">

                <p>Create a redirection link below:</p>
                <div>

                    <label for="url">Choose a short URL:</label>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="url-addon">http://jkmls.tk/</span>
                        </div>
                        <input type="text" class="form-control" id="url" aria-describedby="ur;-addon">
                    </div>
                    <br>
                    <label for="link">Link to redirect to(include http:// or https:// )</label>
                    <input class="form-control" id="link" placeholder="https://" type="text">
                    <br>
                    <p class="text-danger text" id="error"></p>
                    <p class="text-success text" id="success">
                    </p>
                    <button class="form-control btn btn-primary btn-block" id="submit">Submit</button>
                </div>
            </div>
            <script src="https://cdn.jeffkmeng.com/jquery/3.3.1/jquery.min.js"></script>
            <script src="https://cdn.jeffkmeng.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js">
            </script>

            <script>
                /* global firebase $ */
                function checkIfURLExists(id, link, callback) {
                    firebase.database().ref("/links/jmls/" + id + "/link/").once("value", function (data) {
                        var exists = (data.val() !== null);
                        callback(exists, id, link);
                    });
                }
                $(document).on('keyup', function (e) {
                    if (e.keyCode == 13) {
                        $("#submit").click();
                    }
                });

                $("#submit").click(function () {
                    var url = $("#url").val();
                    var link = $("#link").val();

                    var linkregex = new RegExp("(https?:|ftp:)\/\/.+", "g");
                    var urlregex = new RegExp("[A-Za-z0-9-_]", "g");

                    if (!linkregex.test(link)) {
                        $("#success").html("");
                        $("#error").html("The link to redirect to must be valid with http:// or https://");
                    }
                    else if (!urlregex.test(link)) {
                        $("#success").html("");
                        $("#error").html("the short url must only contain dashes(-), underscores(_), and alphanumeric charcters");
                    }
                    else {
                        checkIfURLExists(url, link, function (exists, id, link) {
                            if (exists) {
                                $("#success").html("");
                                $("#error").html("Your url already exists!");
                            }
                            else {
                                $("#link").val("");
                                $("#url").val("");
                                firebase.database().ref("/links/jmls/" + url + "/link/").set(link);
                                $("#success").html("Success! The link <b>http://jkmls.tk/" + url + "<\/b> now redirects to <b>" + link + "<\/b>. If you are embedding this link, use <b>http://jkmls.tk/#" + url + "<\/b>.");
                                url.val("");
                                link.val("");

                            }
                        });
                    }

                });
            </script>
        </div>
    </div>
</body>

</html>