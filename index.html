<!DOCTYPE html>
<html>
    <head>
    
        <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js">
        </script>
        <script>
            /* global Firebase */
            var name = window.location.hash.substring(1);
            var fb = new Firebase("https://redirect.firebaseio.com");
            if (name !== null && name !== "" && name !== undefined) {
                fb.once("value", function(snapshot) {
                    if (snapshot.child(name).val() !== null) {
                        var meta = document.createElement('meta');
                        meta.httpEquiv = "refresh";
                        meta.content = "0; URL=" + snapshot.child(name).val();
                        document.getElementsByTagName('head')[0].appendChild(meta);
    
                    }
                });
            }
    
        </script>
        <link href=
        "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
        rel="stylesheet">
        <title></title>
    </head>
    <body>
        <div class="container">
            <div class="col-lg-12">
                <h1>JMLS(Jeffrey Meng Link Shortner)</h1>
                <p class="text-muted">Jeffrey's link shortning service.</p>
                <div id="create">
                    <p>Welcome to JMLS</p>
                    <p>Create a redirection link below:</p>
                    <div>
                        
                        <label for="basic-url">Choose a URL</label>
                        <div class="input-group">
                            <span class="input-group-addon" id=
                            "basic-addon3">http://jmls.tk#</span>
                            <input aria-describedby="basic-addon3" class=
                            "form-control" id="url" placeholder="url" type="text">
                        </div><br>
                        <p id="console-text" class="text text-success" style="display:none;">Hi,<br> 
                        Type in a command or create a url normally. type /admin logout to logout or /help for help</p>
                        <p id="console" class="text-muted text"></p>
                        <label for="link">Link to redirect to</label> <input class=
                        "form-control" id="link" placeholder=
                        "Please enter the link to redirect to" type="text"><br>
                        <p class="text-danger text" id="error"></p>
                        <p class="text-success text" id="success">
                        </p><button class="form-control" id="sub" style=
                        "background-color:green;color:white;" onclick="setup()">Submit</button>
                    </div>
                </div>
                <script src="http://code.jquery.com/jquery-1.11.3.min.js">
                </script> 
                <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js">
                </script> 
                <script src=
                "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js">
                </script> 
                <script>
                window.onhashchange = function() {
                    setTimeout(function(){window.location.reload();});
                }
                    /* global Firebase */
                var fb = new Firebase("https://redirect.firebaseio.com");

                function checkIfUserExists(id, link, callback) {
                  fb.child(id).once('value', function(snapshot) {
                    var exists = (snapshot.val() !== null);
                    callback(exists, id, link);
                  });
                }
                // /admin login
                // > please enter username:
                //   jmeng
                // > please enter password:
                //   ********* (password)
                // > password incorrect, please try again:
                //   ***************** (superneatpassword)
                // > password accepted, hi Jeffrey
                // /list
                // > List of all redirects
                // /overwrite hi jeffreyisawesome
                // >overwrite complete.
                // /view hi
                // > hi : www.etc.com
                // /delete hi
                // > hi deleted
                // /admin logout
                // >you are logged out
                $(document).keypress(function(e) {
                    if(e.which == 13) {
                        setup();
                    }
                });
                function compute(link) {
                    function printToTerminal(p) {
                        $("#console").append(p + "<br>");
                    }
                    var command = link.substring(1).split(" ");
                        if (command[0] === "authStatus" || command[0] === "authState") {
                            printToTerminal((fb.getAuth() !== null ? "You are logged in as: " + fb.getAuth().password.email : "You are not logged in."))
                        }
                        if (command[0] === "visibility") {
                                if (command[1] === "none" || command[1] === "password") {
                                    $("#link").attr("type", "password");
                                } else if (command[1] !== null) {
                                    $("#link").attr("type", "text")
                                }
                        
                            
                        }
                        if (command[0] === "hide" || command[0] === "password") {
                            $("#link").attr("type", "password");
                        } else if (command[0] === "text" || command[0] === "show") {
                            $("#link").attr("type", "text")
                        }
                
                        if (fb.getAuth() === null) {
                            
                            if (command[0] === "login") {
                                if (command[1] === null || command[2] === null) {
                                    printToTerminal("Error: You failed to specify any username or password(the correct usage should by: /login <username> <password> )")
                                } else {
                                    fb.authWithPassword({
                                      email    : command[1],
                                      password : command[2]
                                    }, function(error, authData) {
                                      if (error) {
                                        printToTerminal("Login Failed! " + error);
                                      } else {
                                        $(".name").html(fb.getAuth().password.email);
                                         $("#console-text").attr("style", "")
                                      }
                                    });
                                    
                                }
                            }
                        } else if (fb.getAuth !== null) {
                            if (command[0] === "logout") {
                                fb.unauth();
                                $("#console-text").attr("style", "display:none;")
                                $("#console").html("")

                            } else if (command[0] === "list") {
                                fb.once("value", function(snapshot) {
                                  snapshot.forEach(function(childSnapshot) {
                                    printToTerminal("name: " + childSnapshot.key() + ", URL: " + childSnapshot.val())
                                  });
                                });
                                
                            } else if (command[0] === "getURL") {
                                fb.child(command[1]).once("value", function(snapshot) {
                                    printToTerminal("name: " + snapshot.key() + ", URL: " + snapshot.val())
                                });
                            } else if (command[0] === "overwrite") {
                                fb.child(command[1]).set(command[2])
                                printToTerminal("The url at '" + command[1] + "' now points to '" + command[2] + "'.")
                            } else if (command[0] === "delete") {
                                fb.child(command[1]).set(null)
                                printToTerminal("The url at '" + command[1] + "' was deleted.")
                            } else if (command[0] === "delete") {
                                $("#console").html("");
                            }
                    
                        }
                }
                function setup() {
                    var fb = new Firebase("https://redirect.firebaseio.com");
                    var url = $("#url").val()
                    var link = $("#link").val();
                    $("#link").val("");
                    $("#url").val("");
                    if (link.substring(0, 1) === "/") {
                        compute(link)
                    } else {
                        checkIfUserExists(url, link, function(exists, id, link){
                            if (exists) {
                                $("#success").html();
                                $("#error").html("Your url already exists!")
                            } else {
                                fb.child(url).set(link);
                                $("#success").html("Success! The link <b>http://jmls.tk#" + url + "<\/b> now redirects to <b>" + link + "<\/b>.");
                                url.val("");
                                link.val("")
                                
                            }
                        });
                    }
                    
                }
    
    
                </script>
            </div>
        </div>
    </body>
</html>